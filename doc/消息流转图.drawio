<mxfile host="drawio-plugin" modified="2024-03-29T03:57:07.938Z" agent="5.0 (Windows NT 6.2; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.45 Safari/537.36" etag="yoxS5Y4ccaeBoqVVkX_M" version="20.5.3" type="embed"><diagram id="Ut2urhdytUp3hO6l_-hm" name="Page-1"><mxGraphModel dx="1438" dy="758" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0"><root><mxCell id="0"/><mxCell id="1" parent="0"/><mxCell id="18" value="" style="rounded=0;whiteSpace=wrap;html=1;fontSize=14;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1"><mxGeometry x="30" y="860" width="1060" height="280" as="geometry"/></mxCell><mxCell id="2" value="" style="shape=cylinder;whiteSpace=wrap;html=1;boundedLbl=1;backgroundOutline=1;fillColor=#ffe6cc;strokeColor=#d79b00;" parent="1" vertex="1"><mxGeometry x="44" y="940" width="330" height="110" as="geometry"/></mxCell><mxCell id="4" value="" style="shape=cylinder;whiteSpace=wrap;html=1;boundedLbl=1;backgroundOutline=1;fillColor=#f8cecc;strokeColor=#b85450;" parent="1" vertex="1"><mxGeometry x="444" y="940" width="330" height="110" as="geometry"/></mxCell><mxCell id="5" value="ScyllaDB&lt;br style=&quot;font-size: 14px;&quot;&gt;" style="text;html=1;resizable=0;autosize=1;align=center;verticalAlign=middle;points=[];fillColor=none;strokeColor=none;rounded=0;fontSize=14;" parent="1" vertex="1"><mxGeometry x="164" y="1070" width="60" height="20" as="geometry"/></mxCell><mxCell id="6" value="MongoDB" style="text;html=1;resizable=0;autosize=1;align=center;verticalAlign=middle;points=[];fillColor=none;strokeColor=none;rounded=0;fontSize=14;" parent="1" vertex="1"><mxGeometry x="599" y="1070" width="70" height="20" as="geometry"/></mxCell><mxCell id="7" value="1）私聊消息&lt;br&gt;每个用户一个逻辑列表" style="text;html=1;resizable=0;autosize=1;align=center;verticalAlign=middle;points=[];fillColor=none;strokeColor=none;rounded=0;fontSize=14;" parent="1" vertex="1"><mxGeometry x="44" y="980" width="160" height="40" as="geometry"/></mxCell><mxCell id="8" value="2）群聊消息&lt;br&gt;每个组一个逻辑列表" style="text;html=1;resizable=0;autosize=1;align=center;verticalAlign=middle;points=[];fillColor=none;strokeColor=none;rounded=0;fontSize=14;" parent="1" vertex="1"><mxGeometry x="224" y="980" width="140" height="40" as="geometry"/></mxCell><mxCell id="9" value="1）用户信息" style="text;html=1;resizable=0;autosize=1;align=center;verticalAlign=middle;points=[];fillColor=none;strokeColor=none;rounded=0;fontSize=14;" parent="1" vertex="1"><mxGeometry x="494" y="1000" width="90" height="20" as="geometry"/></mxCell><mxCell id="10" value="2）群组信息" style="text;html=1;resizable=0;autosize=1;align=center;verticalAlign=middle;points=[];fillColor=none;strokeColor=none;rounded=0;fontSize=14;" parent="1" vertex="1"><mxGeometry x="654" y="1000" width="90" height="20" as="geometry"/></mxCell><mxCell id="11" value="" style="shape=cylinder;whiteSpace=wrap;html=1;boundedLbl=1;backgroundOutline=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1"><mxGeometry x="850" y="870" width="230" height="200" as="geometry"/></mxCell><mxCell id="12" value="ScyllaDB&lt;br style=&quot;font-size: 14px;&quot;&gt;" style="text;html=1;resizable=0;autosize=1;align=center;verticalAlign=middle;points=[];fillColor=none;strokeColor=none;rounded=0;fontSize=14;" parent="1" vertex="1"><mxGeometry x="914" y="1080" width="60" height="20" as="geometry"/></mxCell><mxCell id="16" value="好友关系&lt;br&gt;每个用户三个列表：&lt;br&gt;3）关注，4）粉丝，5）权限控制" style="text;html=1;resizable=0;autosize=1;align=center;verticalAlign=middle;points=[];fillColor=none;strokeColor=none;rounded=0;fontSize=14;" parent="1" vertex="1"><mxGeometry x="834" y="880" width="220" height="60" as="geometry"/></mxCell><mxCell id="17" value="群组关系：&lt;br&gt;6）群组成员表&lt;br&gt;7）用户加入的群" style="text;html=1;resizable=0;autosize=1;align=center;verticalAlign=middle;points=[];fillColor=none;strokeColor=none;rounded=0;fontSize=14;" parent="1" vertex="1"><mxGeometry x="884" y="970" width="120" height="60" as="geometry"/></mxCell><mxCell id="20" value="" style="rounded=0;whiteSpace=wrap;html=1;fontSize=14;fillColor=#e1d5e7;strokeColor=#9673a6;" parent="1" vertex="1"><mxGeometry x="30" y="530" width="1060" height="310" as="geometry"/></mxCell><mxCell id="21" value="" style="rounded=0;whiteSpace=wrap;html=1;fontSize=14;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1"><mxGeometry x="35" y="190" width="1060" height="310" as="geometry"/></mxCell><mxCell id="22" value="" style="shape=cylinder;whiteSpace=wrap;html=1;boundedLbl=1;backgroundOutline=1;fontSize=14;fillColor=#b0e3e6;strokeColor=#0e8088;gradientColor=#ffffff;" parent="1" vertex="1"><mxGeometry x="60" y="560" width="480" height="270" as="geometry"/></mxCell><mxCell id="19" value="Redis" style="text;html=1;resizable=0;autosize=1;align=center;verticalAlign=middle;points=[];fillColor=none;strokeColor=none;rounded=0;fontSize=14;" parent="1" vertex="1"><mxGeometry x="540" y="810" width="50" height="20" as="geometry"/></mxCell><mxCell id="23" value="1）群消息缓存：每个群组一个List，保存最近的若干条消息数据" style="text;html=1;resizable=0;autosize=1;align=left;verticalAlign=middle;points=[];fillColor=none;strokeColor=none;rounded=0;fontSize=14;" parent="1" vertex="1"><mxGeometry x="65" y="640" width="410" height="20" as="geometry"/></mxCell><mxCell id="24" value="" style="shape=cylinder;whiteSpace=wrap;html=1;boundedLbl=1;backgroundOutline=1;fontSize=14;fillColor=#b0e3e6;strokeColor=#0e8088;gradientColor=#ffffff;" parent="1" vertex="1"><mxGeometry x="600" y="573" width="390" height="270" as="geometry"/></mxCell><mxCell id="27" value="2）用户状态频道：用户状态改变的 发布频道，&lt;br&gt;这样多个服务器的内存缓存可以知道去同步" style="text;html=1;resizable=0;autosize=1;align=left;verticalAlign=middle;points=[];fillColor=none;strokeColor=none;rounded=0;fontSize=14;" parent="1" vertex="1"><mxGeometry x="607.5" y="715" width="320" height="50" as="geometry"/></mxCell><mxCell id="29" value="1）已知用户表：所有登录到服务器的用户，用户结构保存关注、粉丝、拉黑权限；&lt;br&gt;&lt;br&gt;好友信息根据 “用户状态频道” 得到状态变化的通知；&lt;br&gt;&lt;br&gt;用户保存2个消息列表：未处理的消息，等待回执的消息；" style="rounded=1;whiteSpace=wrap;html=1;fontSize=14;align=left;fillColor=#99FF99;strokeColor=#ae4132;gradientColor=none;opacity=30;" parent="1" vertex="1"><mxGeometry x="584" y="230" width="390" height="130" as="geometry"/></mxCell><mxCell id="30" value="除了群消息缓存，其他3个表，只要当前登录成员涉及了，就都在内存有对应，使用频道来得到状态变化通知；" style="rounded=1;whiteSpace=wrap;html=1;gradientColor=#97d077;fontSize=14;align=left;fillColor=#d5e8d4;strokeColor=#82b366;opacity=50;verticalAlign=middle;" parent="1" vertex="1"><mxGeometry x="60" y="222.5" width="380" height="155" as="geometry"/></mxCell><mxCell id="31" value="2）群成员表：每个群组使用hash存储群内所有成员的基本信息" style="text;html=1;resizable=0;autosize=1;align=left;verticalAlign=middle;points=[];fillColor=none;strokeColor=none;rounded=0;fontSize=14;" parent="1" vertex="1"><mxGeometry x="65" y="660" width="410" height="30" as="geometry"/></mxCell><mxCell id="32" value="ScyllaDB中7个表，mongoDB中2个表" style="text;html=1;resizable=0;autosize=1;align=center;verticalAlign=middle;points=[];fillColor=none;strokeColor=none;rounded=0;fontSize=14;" parent="1" vertex="1"><mxGeometry x="44" y="1110" width="250" height="20" as="geometry"/></mxCell><mxCell id="33" value="3）群成员分布表：每个群都记录各个服务上登录成员列表，方便消息转发" style="text;html=1;resizable=0;autosize=1;align=left;verticalAlign=middle;points=[];fillColor=none;strokeColor=none;rounded=0;fontSize=14;" parent="1" vertex="1"><mxGeometry x="66" y="690" width="480" height="30" as="geometry"/></mxCell><mxCell id="34" value="4）群成员分布计数：使用hash记录群在每个服务器有登录成员个数" style="text;html=1;resizable=0;autosize=1;align=left;verticalAlign=middle;points=[];fillColor=none;strokeColor=none;rounded=0;fontSize=14;" parent="1" vertex="1"><mxGeometry x="66" y="730" width="430" height="20" as="geometry"/></mxCell><mxCell id="35" value="5）群成员动态频道：使用订阅发布成员的加入、退群、在线状态等；" style="text;html=1;resizable=0;autosize=1;align=left;verticalAlign=middle;points=[];fillColor=none;strokeColor=none;rounded=0;fontSize=14;" parent="1" vertex="1"><mxGeometry x="66" y="770" width="440" height="20" as="geometry"/></mxCell><mxCell id="37" value="1）用户信息表：每个用户一个hash，在&lt;br&gt;用户登录时候加载；或者对方需要发消息时候加载；&lt;br&gt;当群组需要的时候加载；&lt;br&gt;用户登录状态不会体现在底层数据库，登录记录目前不存；" style="text;html=1;resizable=0;autosize=1;align=left;verticalAlign=middle;points=[];fillColor=none;strokeColor=none;rounded=0;fontSize=14;" parent="1" vertex="1"><mxGeometry x="607.5" y="615" width="390" height="80" as="geometry"/></mxCell><mxCell id="38" value="用户发送消息需要根据对方查表，检查权限，对方是否在线等；&lt;br&gt;如果每次都访问redis就会慢，所以使用2个机制保持与redis同步，&lt;br&gt;从redis加载后，如果收到对方的状态改变通知，则需要同步；&lt;br&gt;如果超时没有收到通知则需要同步；" style="text;html=1;resizable=0;autosize=1;align=left;verticalAlign=middle;points=[];fillColor=none;strokeColor=none;rounded=0;fontSize=14;opacity=30;" parent="1" vertex="1"><mxGeometry x="1110" y="230" width="420" height="70" as="geometry"/></mxCell><mxCell id="39" value="群缓存只要在redis中，主要是方便最近登录的用户去加载最新消息；&lt;br&gt;" style="text;html=1;resizable=0;autosize=1;align=center;verticalAlign=middle;points=[];fillColor=none;strokeColor=none;rounded=0;fontSize=14;opacity=30;" parent="1" vertex="1"><mxGeometry x="1100" y="555" width="440" height="20" as="geometry"/></mxCell><mxCell id="40" value="用户发送消息，如果权限检查通过了，则写数据库，&lt;br&gt;写后检查是否转发，&lt;br&gt;如果转发：将消息放在内存中，等待回执；&lt;br&gt;如果不转发：则等对方上线再说；" style="text;html=1;resizable=0;autosize=1;align=left;verticalAlign=middle;points=[];fillColor=none;strokeColor=none;rounded=0;fontSize=14;opacity=30;" parent="1" vertex="1"><mxGeometry x="1110" y="345" width="340" height="70" as="geometry"/></mxCell></root></mxGraphModel></diagram></mxfile>