# 消息存储

# 1. ScyllaDb存储

传输结构

```protobuf
// 聊天存储的基本信息
message MsgChat {
  int64 msgId = 1;                // 消息的全网唯一标识，服务端使用雪花算法生成，因为客户端生成的不可靠
  int64 userId = 2;               // 用于存储的clusterKey，因为一份消息要存储2次，要转发，需要有这个字段

  int64 fromId = 3;              // 发送消息的用户 ID
  int64 toId = 4;                // 接收消息的用户 ID（对方的用户 ID）

  int64 tm = 5;                   // 消息的时间戳

  string devId = 6;               // 多设备登录时的设备 ID
  string sendId = 7;              // 用于确认消息的发送 ID

  ChatMsgType msgType = 8;        // 消息类型，建议使用枚举
  bytes data = 9;                 // 消息的内容，可以使用 bytes 存储二进制数据或文本数据

  MsgPriority priority = 10;      // 消息的优先级，建议使用枚举
  int64 refMessageId = 11;        // 引用的消息 ID，如果有的话

  ChatMsgStatus status = 12;      // 消息状态，建议使用枚举
  int32 sendReply = 13;           // 发送消息的回执状态
  int32 recvReply = 14;           // 接收消息的回执状态
  int32 readReply = 15;           // 已读状态的回执

  EncryptType encType = 16;       // 加密类型
  string chatType = 17;           // p2p, group, system
  int64 keyPrint = 18;
}
```
在传输过程中，私聊和群聊的消息是共用的，



私聊数据库结构，

私聊是写扩散，所以需要在表中对每个人都写一次，区别在于uid1和uid2交换一次，pk肯定也是需要交换的

```go
// 定义数据结构
type PChatDataStore struct {
	Pk   int16 `db:"pk"`
	Uid1 int64 `db:"uid1"`
	Uid2 int64 `db:"uid2"`
	Id   int64 `db:"id"`
	Usid int64 `db:"usid"`
	Tm   int64 `db:"tm"`
	Tm1  int64 `db:"tm1"`
	Tm2  int64 `db:"tm2"`

	Io    int8   `db:"io"`  // 0=out, 1=in
	St    int8   `db:"st"`  // 0=normal, 1=送达,2阅读，
	Ct    int8   `db:"ct"`  // 0=p2p_plain, 1=system, 2=p2_encrypted,
	Mt    int8   `db:"mt"`  // 0=text, 1=pic, 2=
	Print int64  `db:"pr"`  // 秘钥哈希的低8字节作为指纹
	Ref   int64  `db:"ref"` // 引用消息
	Draf  []byte `db:"draf"`
}
```

对应的建表语句：

```sql
CREATE TABLE pchat (
    pk smallint,
    uid1 bigint, 
    uid2 bigint,
    id bigint,
    usid bigint,
    
    tm bigint,
    tm1 bigint,
    tm2 bigint,
    
    io tinyint,
    st tinyint,
    ct tinyint,
    mt tinyint,
    
   
    draf blob,
    pr  varint,
    ref varint,
   
    PRIMARY KEY (pk, uid1, tm, id)
)
```

群聊的存储，字段个数一样，但是名字不一样

```go
type GChatDataStore struct {
	Pk   int16 `db:"pk"`
	Gid  int64 `db:"gid"`
	Uid  int64 `db:"uid"`
	Id   int64 `db:"id"`
	Usid int64 `db:"usid"`
	Tm   int64 `db:"tm"`
	Tm1  int64 `db:"tm1"`
	Tm2  int64 `db:"tm2"`

	Res int8 `db:"res"` // 保留
	St  int8 `db:"st"`  // 0=normal, 1=送达,2阅读，
	Ct  int8 `db:"tt"`  // 0=普通，1=广播
	Mt  int8 `db:"mt"`  // 0=text, 1=pic, 2=

	Print int64  `db:"pr"`  // 秘钥哈希的低8字节作为指纹
	Ref   int64  `db:"ref"` // 引用消息
	Draf  []byte `db:"draf"`
}
```



```cql
CREATE TABLE gchat (
    pk smallint,
    gid bigint,
    uid bigint, 
    id bigint,
    usid bigint,
    
    tm bigint,
    tm1 bigint,
    tm2 bigint,
    
    res tinyint,
    st tinyint,
    ct tinyint,
    mt tinyint,
    
   
    draf blob,
    pr  varint,
    ref varint,
   
    PRIMARY KEY (pk, gid, tm, id)
)
```

```

```

